<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiCar X Simulator</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- CodeMirror pour l'éditeur de code -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    
    <!-- Chart.js pour les graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            font-weight: bold;
            background-color: #f1f1f1;
        }
        
        #robot-view {
            width: 100%;
            height: 300px;
            background-color: #f8f9fa;
            background-image: linear-gradient(#dee2e6 1px, transparent 1px),
                              linear-gradient(90deg, #dee2e6 1px, transparent 1px);
            background-size: 20px 20px;
            border-radius: 5px;
            position: relative;
            border: 2px solid #dee2e6;
            overflow: hidden;
        }
        
        #robot-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }
        
        .robot-body {
            width: 80px;
            height: 120px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            border-radius: 15px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .robot-wheels {
            position: absolute;
            width: 15px;
            height: 40px;
            background-color: #343a40;
            border-radius: 8px;
        }
        
        .wheel-left {
            left: -10px;
            top: 20px;
        }
        
        .wheel-right {
            right: -10px;
            top: 20px;
        }
        
        .wheel-left-back {
            left: -10px;
            bottom: 20px;
        }
        
        .wheel-right-back {
            right: -10px;
            bottom: 20px;
        }
        
        .robot-sensors {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #28a745;
            border-radius: 50%;
        }
        
        .sensor-front {
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .sensor-left {
            left: -4px;
            top: 10px;
        }
        
        .sensor-right {
            right: -4px;
            top: 10px;
        }
        
        .robot-direction {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 15px solid #ffc107;
        }
        
        .camera-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .camera-active {
            background-color: #28a745;
            color: white;
        }
        
        .camera-inactive {
            background-color: #dc3545;
            color: white;
        }
        
        .CodeMirror {
            height: 400px;
            border-radius: 5px;
        }
        
        #terminal {
            height: 200px;
            background-color: #2d2d2d;
            color: #f1f1f1;
            font-family: monospace;
            padding: 10px;
            overflow-y: auto;
            border-radius: 5px;
            white-space: pre-wrap;
        }
        
        .sensor-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .sensor-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .badge-mission {
            font-size: 0.8rem;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 20px;
        }
        
        .progress {
            height: 10px;
            border-radius: 5px;
        }
        
        .nav-tabs .nav-link {
            border-radius: 5px 5px 0 0;
        }
        
        .nav-tabs .nav-link.active {
            font-weight: bold;
        }
        
        .btn-run {
            background-color: #28a745;
            color: white;
        }
        
        .btn-stop {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-reset {
            background-color: #6c757d;
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Barre de navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>PiCar X Simulator
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#"><i class="fas fa-home me-1"></i>Accueil</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-book me-1"></i>Documentation</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="fas fa-question-circle me-1"></i>Aide</a>
                    </li>
                </ul>
                <span class="navbar-text">
                    <i class="fas fa-battery-three-quarters me-1"></i>
                    <span id="battery-percentage">100%</span>
                </span>
            </div>
        </div>
    </nav>
    
    <!-- Contenu principal -->
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Colonne gauche: Caméra et capteurs -->
            <div class="col-md-4">
                <!-- Vue du dessus du robot -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-robot me-2"></i>Vue du dessus
                        <div class="camera-status camera-inactive" id="camera-status">
                            <i class="fas fa-video me-1"></i>Caméra OFF
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="robot-view">
                            <div id="robot-container">
                                <div class="robot-body">
                                    <!-- Direction du robot -->
                                    <div class="robot-direction"></div>
                                    
                                    <!-- Roues -->
                                    <div class="robot-wheels wheel-left"></div>
                                    <div class="robot-wheels wheel-right"></div>
                                    <div class="robot-wheels wheel-left-back"></div>
                                    <div class="robot-wheels wheel-right-back"></div>
                                    
                                    <!-- Capteurs -->
                                    <div class="robot-sensors sensor-front" id="sensor-ultrasonic"></div>
                                    <div class="robot-sensors sensor-left" id="sensor-ir-left"></div>
                                    <div class="robot-sensors sensor-right" id="sensor-ir-right"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-muted">Position</small><br>
                                <span id="robot-position">0.0, 0.0</span>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Orientation</small><br>
                                <span id="robot-orientation">0°</span>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-sm btn-outline-primary" onclick="resetRobotView()">
                                    <i class="fas fa-sync-alt"></i> Centrer
                                </button>
                            </div>
                            <div class="col-12 mt-2">
                                <button class="btn btn-sm btn-warning w-100" id="reset-all">
                                    <i class="fas fa-undo me-1"></i> Remise à zéro complète
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Capteurs -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-microchip me-2"></i>Capteurs
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="sensor-label">Ultrason</div>
                                <div class="sensor-value" id="ultrasonic-value">∞ cm</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="sensor-label">IR Gauche</div>
                                <div class="sensor-value" id="ir-left-value">
                                    <span class="badge bg-secondary">Inactif</span>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="sensor-label">IR Droit</div>
                                <div class="sensor-value" id="ir-right-value">
                                    <span class="badge bg-secondary">Inactif</span>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="sensor-label">Position</div>
                                <div class="sensor-value" id="position-value">0.0, 0.0</div>
                            </div>
                        </div>
                        
                        <!-- Paramètres de suivi de ligne -->
                        <div class="mt-3">
                            <div class="sensor-label">Suivi de ligne</div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label for="line-threshold" class="form-label small">Seuil de détection</label>
                                    <input type="range" class="form-range" id="line-threshold" min="0" max="255" value="128">
                                    <div class="d-flex justify-content-between">
                                        <small>0</small>
                                        <small id="threshold-value">128</small>
                                        <small>255</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label for="line-speed" class="form-label small">Vitesse de base</label>
                                    <input type="range" class="form-range" id="line-speed" min="5" max="50" value="20">
                                    <div class="d-flex justify-content-between">
                                        <small>5</small>
                                        <small id="speed-value">20</small>
                                        <small>50</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label for="line-kp" class="form-label small">Facteur P</label>
                                    <input type="range" class="form-range" id="line-kp" min="0" max="2" step="0.1" value="0.5">
                                    <div class="d-flex justify-content-between">
                                        <small>0</small>
                                        <small id="kp-value">0.5</small>
                                        <small>2</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-sm btn-primary mt-4" id="start-line-following">
                                            <i class="fas fa-play me-1"></i>Suivi de ligne
                                        </button>
                                        <button class="btn btn-sm btn-danger" id="stop-line-following">
                                            <i class="fas fa-stop me-1"></i>Arrêter
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="sensor-label">IMU</div>
                            <div class="chart-container">
                                <canvas id="imu-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Progression -->
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-trophy me-2"></i>Progression
                    </div>
                    <div class="card-body">
                        <h6>Badges</h6>
                        <div class="mb-3">
                            <span class="badge bg-secondary badge-mission">Débutant</span>
                            <span class="badge bg-secondary badge-mission">Pilote</span>
                            <span class="badge bg-secondary badge-mission">Suiveur de ligne</span>
                            <span class="badge bg-secondary badge-mission">Éviteur d'obstacles</span>
                        </div>
                        
                        <h6>Missions complétées</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 25%"></div>
                        </div>
                        <small class="text-muted">1/4 missions terminées</small>
                    </div>
                </div>
            </div>
            
            <!-- Colonne droite: Éditeur de code et terminal -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="codeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="editor-tab" data-bs-toggle="tab" data-bs-target="#editor" type="button" role="tab">
                                    <i class="fas fa-code me-1"></i>Éditeur
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="scenarios-tab" data-bs-toggle="tab" data-bs-target="#scenarios" type="button" role="tab">
                                    <i class="fas fa-tasks me-1"></i>Scénarios
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="codeTabsContent">
                            <!-- Onglet Éditeur -->
                            <div class="tab-pane fade show active" id="editor" role="tabpanel">
                                <div class="mb-3">
                                    <textarea id="code-editor"></textarea>
                                </div>
                                <div class="mb-3">
                                    <div id="terminal"></div>
                                </div>
                                <div class="btn-group">
                                    <button id="run-button" class="btn btn-run">
                                        <i class="fas fa-play me-1"></i>Exécuter
                                    </button>
                                    <button id="stop-button" class="btn btn-stop" disabled>
                                        <i class="fas fa-stop me-1"></i>Arrêter
                                    </button>
                                    <button id="reset-button" class="btn btn-reset">
                                        <i class="fas fa-sync me-1"></i>Réinitialiser
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Onglet Scénarios -->
                            <div class="tab-pane fade" id="scenarios" role="tabpanel">
                                <div class="list-group" id="scenarios-list">
                                    <!-- Les scénarios seront chargés dynamiquement -->
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Chargement...</span>
                                        </div>
                                        <p class="mt-2">Chargement des scénarios...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Graphiques -->
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-chart-line me-2"></i>Télémétrie
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="telemetry-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.min.js"></script>
    
    <script>
        // Initialisation de l'éditeur de code
        const codeEditor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            autoCloseBrackets: true,
            matchBrackets: true
        });
        
        // Code par défaut
        codeEditor.setValue(`#!/usr/bin/env python3
# -*- coding: utf-8 -*-

try:
    import rclpy
    import time
    from picar_api import PiCar
    
    def main():
        # Initialiser ROS 2
        rclpy.init()
        
        # Créer une instance du PiCar
        print("Initialisation du PiCar X...")
        robot = PiCar()
        
        # Attendre que tous les capteurs soient initialisés
        time.sleep(2)
        
        # Votre code ici
        print("Bonjour, PiCar X!")
        
        # Avancer de 30 cm
        robot.drive(distance_cm=30, speed=20)
        
        # Tourner de 90 degrés
        robot.turn(angle_deg=90)
        
        # Nettoyer
        robot.destroy_node()
        rclpy.shutdown()
    
    if __name__ == "__main__":
        main()
except ModuleNotFoundError as e:
    print(f"Erreur: Module manquant - {e}")
    print("\\nSolution: Installez les modules requis avec:")
    print("pip install rclpy")
    print("\\nNote: Dans l'environnement web simulé, certains modules peuvent ne pas être disponibles.")
    print("Pour une utilisation complète, exécutez ce code sur le robot réel ou dans un environnement")
    print("avec tous les modules installés.")
`);
        
        // Terminal
        const terminal = document.getElementById('terminal');
        
        // Fonction pour ajouter du texte au terminal
        function appendToTerminal(text, isError = false) {
            const span = document.createElement('span');
            span.textContent = text + '\n';
            if (isError) {
                span.style.color = '#ff6b6b';
            }
            terminal.appendChild(span);
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        // Boutons
        const runButton = document.getElementById('run-button');
        const stopButton = document.getElementById('stop-button');
        const resetButton = document.getElementById('reset-button');
        
        // Exécuter le code
        runButton.addEventListener('click', function() {
            const code = codeEditor.getValue();
            
            // Vider le terminal
            terminal.innerHTML = '';
            
            // Désactiver le bouton d'exécution et activer le bouton d'arrêt
            runButton.disabled = true;
            stopButton.disabled = false;
            
            // Afficher un message de démarrage
            appendToTerminal('Exécution du code...');
            
            // Envoyer le code au serveur
            fetch('/api/execute_code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    appendToTerminal(data.output);
                } else {
                    appendToTerminal(data.output, true);
                }
            })
            .catch(error => {
                appendToTerminal(`Erreur: ${error.message}`, true);
            })
            .finally(() => {
                // Réactiver le bouton d'exécution et désactiver le bouton d'arrêt
                runButton.disabled = false;
                stopButton.disabled = true;
            });
        });
        
        // Arrêter l'exécution
        stopButton.addEventListener('click', function() {
            appendToTerminal('Arrêt demandé...', true);
            // Dans une implémentation réelle, il faudrait envoyer une requête au serveur
            // pour arrêter l'exécution du code
        });
        
        // Réinitialiser le terminal
        resetButton.addEventListener('click', function() {
            terminal.innerHTML = '';
        });
        
        // Socket.IO pour les données en temps réel
        const socket = io();
        
        // Mise à jour de l'état de la caméra (simulé)
        socket.on('camera_status', function(data) {
            updateCameraStatus(data.active);
        });
        
        // Mise à jour des données des capteurs
        socket.on('sensor_data', function(data) {
            // Ultrason
            const ultrasonicValue = data.ultrasonic; // Déjà en cm
            document.getElementById('ultrasonic-value').textContent = 
                ultrasonicValue < 400 ? ultrasonicValue.toFixed(1) + ' cm' : '∞ cm';
            
            // IR gauche
            const irLeftElement = document.getElementById('ir-left-value');
            irLeftElement.innerHTML = data.ir_left ? 
                '<span class="badge bg-success">Détecté</span>' : 
                '<span class="badge bg-secondary">Inactif</span>';
            
            // IR droit
            const irRightElement = document.getElementById('ir-right-value');
            irRightElement.innerHTML = data.ir_right ? 
                '<span class="badge bg-success">Détecté</span>' : 
                '<span class="badge bg-secondary">Inactif</span>';
            
            // Position
            document.getElementById('position-value').textContent = 
                `${data.position.x.toFixed(2)}, ${data.position.y.toFixed(2)}`;
            
            // Batterie
            document.getElementById('battery-percentage').textContent = 
                `${data.battery.percentage.toFixed(0)}% (${data.battery.voltage.toFixed(1)}V)`;
            
            // Mettre à jour la vue du robot
            updateRobotView(data.position, data.position.theta);
            
            // Mettre à jour les capteurs visuels
            updateSensorVisuals(data.ultrasonic / 100, data.ir_left, data.ir_right);
            
            // Mise à jour des graphiques
            updateIMUChart(data.imu);
            updateTelemetryChart(data);
        });
        
        // Fonction pour réinitialiser la vue du robot
        function resetRobotView() {
            const robotContainer = document.getElementById('robot-container');
            robotContainer.style.transform = 'translate(-50%, -50%) rotate(0deg)';
        }
        
        // Fonction pour mettre à jour l'état de la caméra
        function updateCameraStatus(isActive) {
            const cameraStatus = document.getElementById('camera-status');
            if (isActive) {
                cameraStatus.className = 'camera-status camera-active';
                cameraStatus.innerHTML = '<i class="fas fa-video me-1"></i>Caméra ON';
            } else {
                cameraStatus.className = 'camera-status camera-inactive';
                cameraStatus.innerHTML = '<i class="fas fa-video me-1"></i>Caméra OFF';
            }
        }
        
        // Fonction pour mettre à jour la position et orientation du robot
        function updateRobotView(position, orientation) {
            const robotContainer = document.getElementById('robot-container');
            const robotPosition = document.getElementById('robot-position');
            const robotOrientation = document.getElementById('robot-orientation');
            
            // Mettre à jour la position affichée
            robotPosition.textContent = `${position.x.toFixed(1)}, ${position.y.toFixed(1)}`;
            robotOrientation.textContent = `${(orientation * 180 / Math.PI).toFixed(0)}°`;
            
            // Faire tourner le robot selon son orientation
            robotContainer.style.transform = `translate(-50%, -50%) rotate(${orientation}rad)`;
        }
        
        // Fonction pour mettre à jour les capteurs visuels
        function updateSensorVisuals(ultrasonicDistance, irLeft, irRight) {
            const sensorUltrasonic = document.getElementById('sensor-ultrasonic');
            const sensorIrLeft = document.getElementById('sensor-ir-left');
            const sensorIrRight = document.getElementById('sensor-ir-right');
            
            // Capteur ultrasonique - change de couleur selon la distance
            if (ultrasonicDistance < 0.2) { // < 20cm
                sensorUltrasonic.style.backgroundColor = '#dc3545'; // Rouge
            } else if (ultrasonicDistance < 0.5) { // < 50cm
                sensorUltrasonic.style.backgroundColor = '#ffc107'; // Jaune
            } else {
                sensorUltrasonic.style.backgroundColor = '#28a745'; // Vert
            }
            
            // Capteurs IR
            sensorIrLeft.style.backgroundColor = irLeft ? '#007bff' : '#28a745';
            sensorIrRight.style.backgroundColor = irRight ? '#007bff' : '#28a745';
        }
        
        // Chargement des scénarios
        function loadScenarios() {
            fetch('/api/scenarios')
                .then(response => response.json())
                .then(scenarios => {
                    const scenariosList = document.getElementById('scenarios-list');
                    scenariosList.innerHTML = '';
                    
                    scenarios.forEach(scenario => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.dataset.id = scenario.id;
                        
                        const badge = document.createElement('span');
                        badge.className = `badge float-end ${scenario.completed ? 'bg-success' : 'bg-secondary'}`;
                        badge.textContent = scenario.completed ? 'Terminé' : 'À faire';
                        
                        const title = document.createElement('h5');
                        title.className = 'mb-1';
                        title.textContent = scenario.name;
                        
                        const description = document.createElement('p');
                        description.className = 'mb-1';
                        description.textContent = scenario.description;
                        
                        const difficulty = document.createElement('small');
                        difficulty.className = 'text-muted';
                        difficulty.textContent = `Difficulté: ${scenario.difficulty}`;
                        
                        item.appendChild(badge);
                        item.appendChild(title);
                        item.appendChild(description);
                        item.appendChild(difficulty);
                        
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            loadScenario(scenario.id);
                        });
                        
                        scenariosList.appendChild(item);
                    });
                })
                .catch(error => {
                    console.error('Erreur lors du chargement des scénarios:', error);
                    document.getElementById('scenarios-list').innerHTML = 
                        '<div class="alert alert-danger">Erreur lors du chargement des scénarios</div>';
                });
        }
        
        // Chargement d'un scénario spécifique
        function loadScenario(scenarioId) {
            fetch(`/api/scenario/${scenarioId}`)
                .then(response => response.json())
                .then(scenario => {
                    // Changer d'onglet
                    document.getElementById('editor-tab').click();
                    
                    // Mettre à jour l'éditeur de code
                    codeEditor.setValue(scenario.code_template);
                    
                    // Afficher les instructions dans le terminal
                    terminal.innerHTML = '';
                    appendToTerminal(`=== ${scenario.name} ===`);
                    appendToTerminal(`Description: ${scenario.description}`);
                    appendToTerminal(`Difficulté: ${scenario.difficulty}`);
                    appendToTerminal(`Temps estimé: ${scenario.estimated_time}`);
                    appendToTerminal('\nInstructions:');
                    scenario.instructions.forEach((instruction, index) => {
                        appendToTerminal(`${index + 1}. ${instruction}`);
                    });
                    appendToTerminal('\nModifiez le code dans l\'éditeur et cliquez sur "Exécuter" pour commencer.');
                })
                .catch(error => {
                    console.error('Erreur lors du chargement du scénario:', error);
                    terminal.innerHTML = '';
                    appendToTerminal(`Erreur lors du chargement du scénario: ${error.message}`, true);
                });
        }
        
        // Initialisation des graphiques
        let imuChart, telemetryChart;
        
        function initCharts() {
            // Graphique IMU
            const imuCtx = document.getElementById('imu-chart').getContext('2d');
            imuChart = new Chart(imuCtx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [
                        {
                            label: 'Acc X',
                            data: Array(20).fill(0),
                            borderColor: 'rgba(255, 99, 132, 1)',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Acc Y',
                            data: Array(20).fill(0),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Acc Z',
                            data: Array(20).fill(0),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: -10,
                            max: 10
                        }
                    },
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 10
                            }
                        }
                    }
                }
            });
            
            // Graphique de télémétrie
            const telemetryCtx = document.getElementById('telemetry-chart').getContext('2d');
            telemetryChart = new Chart(telemetryCtx, {
                type: 'line',
                data: {
                    labels: Array(20).fill(''),
                    datasets: [
                        {
                            label: 'Vitesse',
                            data: Array(20).fill(0),
                            borderColor: 'rgba(255, 159, 64, 1)',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Distance',
                            data: Array(20).fill(0),
                            borderColor: 'rgba(153, 102, 255, 1)',
                            tension: 0.4,
                            borderWidth: 2,
                            pointRadius: 0,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Vitesse (cm/s)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Distance (cm)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                boxWidth: 10
                            }
                        }
                    }
                }
            });
        }
        
        // Mise à jour du graphique IMU
        function updateIMUChart(imuData) {
            if (!imuChart) return;
            
            // Ajouter les nouvelles données
            imuChart.data.datasets[0].data.push(imuData.linear_acceleration.x);
            imuChart.data.datasets[1].data.push(imuData.linear_acceleration.y);
            imuChart.data.datasets[2].data.push(imuData.linear_acceleration.z);
            
            // Supprimer les anciennes données
            if (imuChart.data.datasets[0].data.length > 20) {
                imuChart.data.datasets[0].data.shift();
                imuChart.data.datasets[1].data.shift();
                imuChart.data.datasets[2].data.shift();
            }
            
            // Mettre à jour le graphique
            imuChart.update();
        }
        
        // Mise à jour du graphique de télémétrie
        let lastPosition = { x: 0, y: 0 };
        let speed = 0;
        
        function updateTelemetryChart(data) {
            if (!telemetryChart) return;
            
            // Calculer la vitesse
            const dx = data.position.x - lastPosition.x;
            const dy = data.position.y - lastPosition.y;
            const distance = Math.sqrt(dx*dx + dy*dy);
            speed = distance * 100 / 0.1; // cm/s (en supposant une mise à jour toutes les 100ms)
            
            // Mettre à jour la dernière position
            lastPosition = { x: data.position.x, y: data.position.y };
            
            // Ajouter les nouvelles données
            telemetryChart.data.datasets[0].data.push(speed);
            telemetryChart.data.datasets[1].data.push(data.ultrasonic * 100); // cm
            
            // Supprimer les anciennes données
            if (telemetryChart.data.datasets[0].data.length > 20) {
                telemetryChart.data.datasets[0].data.shift();
                telemetryChart.data.datasets[1].data.shift();
            }
            
            // Mettre à jour le graphique
            telemetryChart.update();
        }
        
        // Gestionnaire pour les sliders du suivi de ligne
        document.getElementById('line-threshold').addEventListener('input', function() {
            document.getElementById('threshold-value').textContent = this.value;
        });
        
        document.getElementById('line-speed').addEventListener('input', function() {
            document.getElementById('speed-value').textContent = this.value;
        });
        
        document.getElementById('line-kp').addEventListener('input', function() {
            document.getElementById('kp-value').textContent = this.value;
        });
        
        // Fonction pour le suivi de ligne
        document.getElementById('start-line-following').addEventListener('click', function() {
            const threshold = document.getElementById('line-threshold').value;
            const speed = document.getElementById('line-speed').value;
            const kp = document.getElementById('line-kp').value;
            
            // Générer du code Python pour le suivi de ligne
            const lineFollowingCode = `#!/usr/bin/env python3
# -*- coding: utf-8 -*-

try:
    import rclpy
    import time
    import cv2
    import numpy as np
    from picar_api import PiCar
    
    def main():
        # Initialiser ROS 2
        rclpy.init()
        
        # Créer une instance du PiCar
        print("Initialisation du PiCar X...")
        robot = PiCar()
        
        # Paramètres du suivi de ligne
        THRESHOLD = ${threshold}  # Seuil pour la détection de ligne (0-255)
        BASE_SPEED = ${speed}     # Vitesse de base
        KP = ${kp}                # Facteur P pour le PID
        
        print(f"Démarrage du suivi de ligne avec:")
        print(f"- Seuil: {THRESHOLD}")
        print(f"- Vitesse: {BASE_SPEED}")
        print(f"- Facteur P: {KP}")
        
        try:
            # Activer la caméra
            robot.camera.start()
            time.sleep(1)  # Attendre que la caméra s'initialise
            
            running = True
            while running:
                # Obtenir l'image de la caméra
                frame = robot.camera.get_frame()
                
                if frame is None:
                    print("Aucune image reçue")
                    break
                
                # Prétraitement de l'image
                gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
                blur = cv2.GaussianBlur(gray, (5, 5), 0)
                _, thresh = cv2.threshold(blur, THRESHOLD, 255, cv2.THRESH_BINARY_INV)
                
                # Détecter la position de la ligne
                height, width = thresh.shape
                roi = thresh[height-50:height, 0:width]
                
                # Calculer le centre de la ligne
                M = cv2.moments(roi)
                if M["m00"] > 0:
                    cx = int(M["m10"] / M["m00"])
                    
                    # Calculer l'erreur par rapport au centre
                    error = cx - width/2
                    
                    # Calculer la correction
                    correction = KP * error
                    
                    # Calculer les vitesses des roues
                    left_speed = max(0, min(100, BASE_SPEED - correction))
                    right_speed = max(0, min(100, BASE_SPEED + correction))
                    
                    # Déplacer le robot
                    robot.set_motors(left_speed, right_speed)
                    
                    print(f"Ligne détectée: {cx}, Erreur: {error:.2f}, Correction: {correction:.2f}")
                else:
                    print("Ligne perdue")
                    robot.stop()
                
                # Pause courte pour limiter l'utilisation du CPU
                time.sleep(0.05)
                
        except KeyboardInterrupt:
            print("Arrêt demandé par l'utilisateur")
        finally:
            # Arrêter le robot
            robot.stop()
            robot.camera.stop()
            robot.destroy_node()
            rclpy.shutdown()
    
    if __name__ == "__main__":
        main()
except ModuleNotFoundError as e:
    print(f"Erreur: Module manquant - {e}")
    print("\\nSolution: Installez les modules requis avec:")
    print("pip install opencv-python numpy rclpy")
    print("\\nNote: Dans l'environnement web simulé, certains modules peuvent ne pas être disponibles.")
    print("Pour une utilisation complète, exécutez ce code sur le robot réel ou dans un environnement")
    print("avec tous les modules installés.")`;
            
            // Mettre à jour l'éditeur avec le code de suivi de ligne
            codeEditor.setValue(lineFollowingCode);
            
            // Exécuter le code
            runCode();
        });
        
        // Arrêter le suivi de ligne
        document.getElementById('stop-line-following').addEventListener('click', function() {
            if (runningProcess) {
                stopCode();
            }
        });
        
        // Remise à zéro complète
        document.getElementById('reset-all').addEventListener('click', function() {
            // Réinitialiser la position du robot
            resetRobotView();
            
            // Réinitialiser les paramètres de suivi de ligne
            document.getElementById('line-threshold').value = 128;
            document.getElementById('threshold-value').textContent = "128";
            
            document.getElementById('line-speed').value = 20;
            document.getElementById('speed-value').textContent = "20";
            
            document.getElementById('line-kp').value = 0.5;
            document.getElementById('kp-value').textContent = "0.5";
            
            // Réinitialiser l'éditeur avec le code par défaut
            codeEditor.setValue(`#!/usr/bin/env python3
# -*- coding: utf-8 -*-

try:
    import rclpy
    import time
    from picar_api import PiCar
    
    def main():
        # Initialiser ROS 2
        rclpy.init()
        
        # Créer une instance du PiCar
        print("Initialisation du PiCar X...")
        robot = PiCar()
        
        # Attendre que tous les capteurs soient initialisés
        time.sleep(2)
        
        # Votre code ici
        print("Bonjour, PiCar X!")
        
        # Avancer de 30 cm
        robot.drive(distance_cm=30, speed=20)
        
        # Tourner de 90 degrés
        robot.turn(angle_deg=90)
        
        # Nettoyer
        robot.destroy_node()
        rclpy.shutdown()
    
    if __name__ == "__main__":
        main()
except ModuleNotFoundError as e:
    print(f"Erreur: Module manquant - {e}")
    print("\\nSolution: Installez les modules requis avec:")
    print("pip install rclpy")
    print("\\nNote: Dans l'environnement web simulé, certains modules peuvent ne pas être disponibles.")
    print("Pour une utilisation complète, exécutez ce code sur le robot réel ou dans un environnement")
    print("avec tous les modules installés.")`);
            
            // Effacer le terminal
            terminal.innerHTML = '';
            appendToTerminal('=== PiCar X Simulator ===');
            appendToTerminal('Système réinitialisé.');
            appendToTerminal('Écrivez votre code dans l\'éditeur et cliquez sur "Exécuter" pour le lancer.');
        });
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Charger les scénarios
            loadScenarios();
            
            // Initialiser les graphiques
            initCharts();
            
            // Message de bienvenue
            appendToTerminal('=== PiCar X Simulator ===');
            appendToTerminal('Bienvenue dans le simulateur PiCar X!');
            appendToTerminal('Écrivez votre code dans l\'éditeur et cliquez sur "Exécuter" pour le lancer.');
            appendToTerminal('Vous pouvez également choisir un scénario prédéfini dans l\'onglet "Scénarios".');
            appendToTerminal('\nNote: Si vous rencontrez des erreurs de modules manquants, utilisez la fonction');
            appendToTerminal('de remise à zéro qui inclut la gestion des erreurs de modules.');
        });
    </script>
</body>
</html>